var C=Object.defineProperty;var F=(i,e,r)=>e in i?C(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var L=(i,e,r)=>(F(i,typeof e!="symbol"?e+"":e,r),r);import{W as O,T as U,S as z,a as W,C as y,P as q,O as J,D as G,A as $,b as K,G as Q,e as S,w as j,x as X,u as l,E as b,Q as D,c as Y,V as g,d as M,F as Z,f as _}from"./vendor.3d2cf388.js";const ee=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))d(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&d(c)}).observe(document,{childList:!0,subtree:!0});function r(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerpolicy&&(s.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?s.credentials="include":a.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function d(a){if(a.ep)return;a.ep=!0;const s=r(a);fetch(a.href,s)}};ee();const u=new O({alpha:!0});u.setSize(window.innerWidth,window.innerHeight);u.setPixelRatio(window.devicePixelRatio);const N=U.from(u.domElement),m=new z,k=new W,A=localStorage.getItem("background");if(A){const i=JSON.parse(A);if(i.type==="color"||i.type==="colour"){const e=i.data;m.background=new y(parseInt(e.replace("#",""),16))}else if(i.type==="img"){const e=k.load(i.data);m.background=e}}const R=new q(35,window.innerWidth/window.innerHeight,.1,1e3);R.position.set(0,1.4,.7);const x=new J(R,u.domElement);x.screenSpacePanning=!0;x.target.set(0,1.4,0);x.update();const H=new G(16777215);H.position.set(1,1,1).normalize();m.add(H);const w=new $({height:innerHeight,width:innerWidth,antialias:!0,powerPreference:"high-performance",backgroundColor:16777215}),V=w.stage,te=w.view;w.loader;V.interactive=!0;V.addChild(new K(N));const ie=new Q,I=class extends S.exports.EventEmitter{constructor(){super(...arguments);L(this,"currentModel",null)}static getInstance(){return this.instance||(this.instance=new I),this.instance}loadModel(e){ie.load(e,async r=>{j.removeUnnecessaryJoints(r.scene);const d=await X.from(r);this.currentModel=d,d.scene.rotation.y=Math.PI,this.emit("modelLoaded",d)},r=>console.log("Loading model...",100*(r.loaded/r.total),"%"),r=>console.error(r))}getModel(){return this.currentModel?this.currentModel:null}cleanModel(){this.currentModel&&(m.remove(this.currentModel.scene),this.currentModel=null)}};let h=I;L(h,"instance");function ne(i,e){return i in e}const n=(i,e,r={x:0,y:0,z:0},d=1,a=.3)=>{var t;let s;if(ne(e,l.HumanoidBoneName)&&(s=(t=i==null?void 0:i.humanoid)==null?void 0:t.getBoneNode(l.HumanoidBoneName[e])),!s)return;const c=new b(r.x*d,r.y*d,r.z*d),p=new D().setFromEuler(c);s.quaternion.slerp(p,a)},E=h.getInstance(),oe=i=>{var r,d,a,s,c,p;const e=E.getModel();if(!!e){if(i.face){const t=i.face,o=e.blendShapeProxy,B=new b(t.head.x,t.head.y,t.head.z);(d=(r=e.humanoid)==null?void 0:r.getBoneNode(l.HumanoidBoneName.Neck))==null||d.quaternion.slerp(new D().setFromEuler(B),.7),t.eye.l=g.lerp(M(1-t.eye.l,0,1),o==null?void 0:o.getValue(l.BlendShapePresetName.Blink),.7),t.eye.r=g.lerp(M(1-t.eye.r,0,1),o==null?void 0:o.getValue(l.BlendShapePresetName.Blink),.7);const P=Z.stabilizeBlink(t.eye,t.head.y);o==null||o.setValue(l.BlendShapePresetName.BlinkL,P.l),o==null||o.setValue(l.BlendShapePresetName.BlinkR,P.r),o==null||o.setValue(l.BlendShapePresetName.I,g.lerp(t.mouth.shape.I,o.getValue(l.BlendShapePresetName.I),.4)),o==null||o.setValue(l.BlendShapePresetName.A,g.lerp(t.mouth.shape.A,o.getValue(l.BlendShapePresetName.A),.4)),o==null||o.setValue(l.BlendShapePresetName.E,g.lerp(t.mouth.shape.E,o.getValue(l.BlendShapePresetName.E),.4)),o==null||o.setValue(l.BlendShapePresetName.O,g.lerp(t.mouth.shape.O,o.getValue(l.BlendShapePresetName.O),.4)),o==null||o.setValue(l.BlendShapePresetName.U,g.lerp(t.mouth.shape.U,o.getValue(l.BlendShapePresetName.U),.4))}if(i.pose){const t=i.pose;n(e,"Hips",t.Hips.rotation,.7);const o=(s=(a=e.humanoid)==null?void 0:a.getBoneNode(l.HumanoidBoneName.Hips))==null?void 0:s.position;(p=(c=e.humanoid)==null?void 0:c.getBoneNode(l.HumanoidBoneName.Hips))==null||p.position.lerp(new _(o==null?void 0:o.x,o==null?void 0:o.y,-t.Hips.position.z),.07),n(e,"Chest",t.Spine,.25,.3),n(e,"Spine",t.Spine,.45,.3),n(e,"RightUpperArm",t.RightUpperArm,1,.3),n(e,"RightLowerArm",t.RightLowerArm,1,.3),n(e,"LeftUpperArm",t.LeftUpperArm,1,.3),n(e,"LeftLowerArm",t.LeftLowerArm,1,.3),n(e,"LeftUpperLeg",t.LeftUpperLeg,1,.3),n(e,"LeftLowerLeg",t.LeftLowerLeg,1,.3),n(e,"RightUpperLeg",t.RightUpperLeg,1,.3),n(e,"RightLowerLeg",t.RightLowerLeg,1,.3)}if(i.handL&&i.pose){const t=i.handL;n(e,"LeftHand",{z:i.pose.LeftHand.z,y:t.LeftWrist.y,x:t.LeftWrist.x}),n(e,"LeftRingProximal",t.LeftRingProximal),n(e,"LeftRingIntermediate",t.LeftRingIntermediate),n(e,"LeftRingDistal",t.LeftRingDistal),n(e,"LeftIndexProximal",t.LeftIndexProximal),n(e,"LeftIndexIntermediate",t.LeftIndexIntermediate),n(e,"LeftIndexDistal",t.LeftIndexDistal),n(e,"LeftMiddleProximal",t.LeftMiddleProximal),n(e,"LeftMiddleIntermediate",t.LeftMiddleIntermediate),n(e,"LeftMiddleDistal",t.LeftMiddleDistal),n(e,"LeftThumbProximal",t.LeftThumbProximal),n(e,"LeftThumbIntermediate",t.LeftThumbIntermediate),n(e,"LeftThumbDistal",t.LeftThumbDistal),n(e,"LeftLittleProximal",t.LeftLittleProximal),n(e,"LeftLittleIntermediate",t.LeftLittleIntermediate),n(e,"LeftLittleDistal",t.LeftLittleDistal)}if(i.handR&&i.pose){const t=i.handR;n(e,"RightHand",{z:i.pose.RightHand.z,y:t.RightWrist.y,x:t.RightWrist.x}),n(e,"RightRingProximal",t.RightRingProximal),n(e,"RightRingIntermediate",t.RightRingIntermediate),n(e,"RightRingDistal",t.RightRingDistal),n(e,"RightIndexProximal",t.RightIndexProximal),n(e,"RightIndexIntermediate",t.RightIndexIntermediate),n(e,"RightIndexDistal",t.RightIndexDistal),n(e,"RightMiddleProximal",t.RightMiddleProximal),n(e,"RightMiddleIntermediate",t.RightMiddleIntermediate),n(e,"RightMiddleDistal",t.RightMiddleDistal),n(e,"RightThumbProximal",t.RightThumbProximal),n(e,"RightThumbIntermediate",t.RightThumbIntermediate),n(e,"RightThumbDistal",t.RightThumbDistal),n(e,"RightLittleProximal",t.RightLittleProximal),n(e,"RightLittleIntermediate",t.RightLittleIntermediate),n(e,"RightLittleDistal",t.RightLittleDistal)}}};E.on("modelLoaded",i=>{m.add(i.scene);const e=new Y;function r(){i.update(e.getDelta()),u.render(m,R),N.update(),requestAnimationFrame(r)}requestAnimationFrame(r)});const T=new WebSocket("ws://127.0.0.1:8008/control"),f=new S.exports.EventEmitter;T.onmessage=i=>{try{const e=JSON.parse(i.data);f.emit(e.cmd,e.data)}catch(e){console.error(e)}};T.onopen=()=>{console.log("\u5DF2\u8FDE\u63A5\u5230\u540E\u7AEF")};const re=document.querySelector("#app"),v=h.getInstance();re.appendChild(te);h.getInstance().loadModel("/api/getModel3D");f.on("reload-model",()=>{console.log("\u91CD\u65B0\u52A0\u8F7D\u6A21\u578B"),v.cleanModel(),v.loadModel("/api/getModel3D")});f.on("set-new-background",i=>{if(console.log(i),localStorage.setItem("background",JSON.stringify(i)),i.type==="color"||i.type==="colour"){const e=i.data;m.background=new y(parseInt(e.replace("#",""),16))}else if(i.type==="img"){const e=k.load(i.data);m.background=e}});f.on("set-pose",i=>{oe(i)});
