var T=Object.defineProperty;var z=(i,t,r)=>t in i?T(i,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[t]=r;var p=(i,t,r)=>(z(i,typeof t!="symbol"?t+"":t,r),r);import{W as B,T as C,S as F,a as O,C as P,P as U,O as W,D as q,A as J,b as G,G as $,e as I,w as K,x as Q,u as a,E as y,Q as S,V as j,c as X,d as m,f as b,F as Y}from"./vendor.66a272c1.js";const Z=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))l(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function r(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerpolicy&&(n.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?n.credentials="include":e.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function l(e){if(e.ep)return;e.ep=!0;const n=r(e);fetch(e.href,n)}};Z();const g=new B({alpha:!0});g.setSize(window.innerWidth,window.innerHeight);g.setPixelRatio(window.devicePixelRatio);const D=C.from(g.domElement),d=new F,M=new O,N=localStorage.getItem("background");if(N)try{const i=JSON.parse(N);if(i.type==="color"||i.type==="colour"){const t=i.data;d.background=new P(parseInt(t.replace("#",""),16))}else if(i.type==="img"){const t=M.load(i.data);d.background=t}}catch(i){console.log(i),localStorage.removeItem("background")}const f=new U(35,window.innerWidth/window.innerHeight,.1,1e3);f.position.set(0,1.4,.7);const L=new W(f,g.domElement);L.screenSpacePanning=!0;L.target.set(0,1.4,0);L.update();const k=new q(16777215);k.position.set(1,1,1).normalize();d.add(k);const R=new J({height:innerHeight,width:innerWidth,antialias:!0,powerPreference:"high-performance",backgroundColor:16777215}),A=R.stage,_=R.view;R.loader;A.interactive=!0;A.addChild(new G(D));const ee=new $,x=class extends I.exports.EventEmitter{constructor(){super(...arguments);p(this,"currentModel",null)}static getInstance(){return this.instance||(this.instance=new x),this.instance}loadModel(t){ee.load(t,async r=>{K.removeUnnecessaryJoints(r.scene);const l=await Q.from(r);this.currentModel=l,l.scene.rotation.y=Math.PI,this.emit("modelLoaded",l)},r=>console.log("Loading model...",100*(r.loaded/r.total),"%"),r=>console.error(r))}getModel(){return this.currentModel?this.currentModel:null}cleanModel(){this.currentModel&&(d.remove(this.currentModel.scene),this.currentModel=null)}};let u=x;p(u,"instance");function H(i,t){return i in t}const o=(i,t,r={x:0,y:0,z:0},l=1,e=.3)=>{var w;let n;if(H(t,a.HumanoidBoneName)&&(n=(w=i==null?void 0:i.humanoid)==null?void 0:w.getBoneNode(a.HumanoidBoneName[t])),!n)return;const s=new y(r.x*l,r.y*l,r.z*l),c=new S().setFromEuler(s);n.quaternion.slerp(c,e)},te=(i,t,r={x:0,y:0,z:0},l=1,e=.3)=>{var c;let n;if(H(t,a.HumanoidBoneName)&&(n=(c=i==null?void 0:i.humanoid)==null?void 0:c.getBoneNode(a.HumanoidBoneName[t])),!n)return;const s=new j(r.x*l,r.y*l,r.z*l);n.position.lerp(s,e)},V=u.getInstance(),ie=i=>{var r,l;const t=V.getModel();if(!!t){if(i.face){const e=i.face,n=t.blendShapeProxy,s=new y(e.head.x,e.head.y,e.head.z);(l=(r=t.humanoid)==null?void 0:r.getBoneNode(a.HumanoidBoneName.Neck))==null||l.quaternion.slerp(new S().setFromEuler(s),.7),e.eye.l=m.lerp(b(1-e.eye.l,0,1),n==null?void 0:n.getValue(a.BlendShapePresetName.Blink),.7),e.eye.r=m.lerp(b(1-e.eye.r,0,1),n==null?void 0:n.getValue(a.BlendShapePresetName.Blink),.7);const c=Y.stabilizeBlink(e.eye,e.head.y);n==null||n.setValue(a.BlendShapePresetName.BlinkL,c.l),n==null||n.setValue(a.BlendShapePresetName.BlinkR,c.r),n==null||n.setValue(a.BlendShapePresetName.I,m.lerp(e.mouth.shape.I,n.getValue(a.BlendShapePresetName.I),.4)),n==null||n.setValue(a.BlendShapePresetName.A,m.lerp(e.mouth.shape.A,n.getValue(a.BlendShapePresetName.A),.4)),n==null||n.setValue(a.BlendShapePresetName.E,m.lerp(e.mouth.shape.E,n.getValue(a.BlendShapePresetName.E),.4)),n==null||n.setValue(a.BlendShapePresetName.O,m.lerp(e.mouth.shape.O,n.getValue(a.BlendShapePresetName.O),.4)),n==null||n.setValue(a.BlendShapePresetName.U,m.lerp(e.mouth.shape.U,n.getValue(a.BlendShapePresetName.U),.4))}if(i.pose){const e=i.pose;o(t,"Hips",e.Hips.rotation,.7),te(t,"Hips",{x:-e.Hips.position.x,y:e.Hips.position.y+.9,z:-e.Hips.position.z},1,.07),o(t,"Chest",e.Spine,.25,.3),o(t,"Spine",e.Spine,.45,.3),o(t,"RightUpperArm",e.RightUpperArm,1,.3),o(t,"RightLowerArm",e.RightLowerArm,1,.3),o(t,"LeftUpperArm",e.LeftUpperArm,1,.3),o(t,"LeftLowerArm",e.LeftLowerArm,1,.3),o(t,"LeftUpperLeg",e.LeftUpperLeg,1,.3),o(t,"LeftLowerLeg",e.LeftLowerLeg,1,.3),o(t,"RightUpperLeg",e.RightUpperLeg,1,.3),o(t,"RightLowerLeg",e.RightLowerLeg,1,.3)}if(i.handL&&i.pose){const e=i.handL;o(t,"LeftHand",{z:i.pose.LeftHand.z,y:e.LeftWrist.y,x:e.LeftWrist.x}),o(t,"LeftRingProximal",e.LeftRingProximal),o(t,"LeftRingIntermediate",e.LeftRingIntermediate),o(t,"LeftRingDistal",e.LeftRingDistal),o(t,"LeftIndexProximal",e.LeftIndexProximal),o(t,"LeftIndexIntermediate",e.LeftIndexIntermediate),o(t,"LeftIndexDistal",e.LeftIndexDistal),o(t,"LeftMiddleProximal",e.LeftMiddleProximal),o(t,"LeftMiddleIntermediate",e.LeftMiddleIntermediate),o(t,"LeftMiddleDistal",e.LeftMiddleDistal),o(t,"LeftThumbProximal",e.LeftThumbProximal),o(t,"LeftThumbIntermediate",e.LeftThumbIntermediate),o(t,"LeftThumbDistal",e.LeftThumbDistal),o(t,"LeftLittleProximal",e.LeftLittleProximal),o(t,"LeftLittleIntermediate",e.LeftLittleIntermediate),o(t,"LeftLittleDistal",e.LeftLittleDistal)}if(i.handR&&i.pose){const e=i.handR;o(t,"RightHand",{z:i.pose.RightHand.z,y:e.RightWrist.y,x:e.RightWrist.x}),o(t,"RightRingProximal",e.RightRingProximal),o(t,"RightRingIntermediate",e.RightRingIntermediate),o(t,"RightRingDistal",e.RightRingDistal),o(t,"RightIndexProximal",e.RightIndexProximal),o(t,"RightIndexIntermediate",e.RightIndexIntermediate),o(t,"RightIndexDistal",e.RightIndexDistal),o(t,"RightMiddleProximal",e.RightMiddleProximal),o(t,"RightMiddleIntermediate",e.RightMiddleIntermediate),o(t,"RightMiddleDistal",e.RightMiddleDistal),o(t,"RightThumbProximal",e.RightThumbProximal),o(t,"RightThumbIntermediate",e.RightThumbIntermediate),o(t,"RightThumbDistal",e.RightThumbDistal),o(t,"RightLittleProximal",e.RightLittleProximal),o(t,"RightLittleIntermediate",e.RightLittleIntermediate),o(t,"RightLittleDistal",e.RightLittleDistal)}}};V.on("modelLoaded",i=>{d.add(i.scene);const t=new X;function r(){i.update(t.getDelta()),g.render(d,f),D.update(),requestAnimationFrame(r)}requestAnimationFrame(r)});const E=new WebSocket("ws://127.0.0.1:8008/control"),h=new I.exports.EventEmitter;E.onmessage=i=>{try{const t=JSON.parse(i.data);h.emit(t.cmd,t.data)}catch(t){console.error(t)}};E.onopen=()=>{console.log("\u5DF2\u8FDE\u63A5\u5230\u540E\u7AEF")};const ne=document.querySelector("#app"),v=u.getInstance();ne.appendChild(_);u.getInstance().loadModel("/api/getModel3D");h.on("reload-model",()=>{console.log("\u91CD\u65B0\u52A0\u8F7D\u6A21\u578B"),v.cleanModel(),v.loadModel("/api/getModel3D")});h.on("set-new-background",i=>{if(console.log(i),localStorage.setItem("background",JSON.stringify(i)),i.type==="color"||i.type==="colour"){const t=i.data;d.background=new P(parseInt(t.replace("#",""),16))}else if(i.type==="img"){const t=M.load(i.data);d.background=t}});h.on("set-pose",i=>{ie(i)});
